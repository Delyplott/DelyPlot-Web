name: delyplott-worker-dispatch

on:
  schedule:
    - cron: "*/5 * * * *"

  workflow_dispatch:
    inputs:
      orderId:
        description: "Order ID (Firestore) a procesar (opcional; vacÃ­o = cola)"
        required: false
        type: string

  repository_dispatch:
    types: [run-worker]

permissions:
  contents: read

jobs:
  worker:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write Firebase credentials
        working-directory: backend
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        run: |
          printf '%s' "$FIREBASE_SERVICE_ACCOUNT_JSON" > firebase_sa.json

      - name: Run worker (auto queue window)
        working-directory: backend
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/backend/firebase_sa.json
          APPS_SCRIPT_URL: ${{ secrets.APPS_SCRIPT_URL }}
          WORKER_SECRET: ${{ secrets.WORKER_SECRET }}
          RUN_ONCE: "1"
          RUN_WINDOW_SECS: "240"
          POLL_SECS: "4"
          BATCH_LIMIT: "5"
          ORDER_WAIT_SECS: "10"
          ORDER_ID: ${{ github.event.inputs.orderId || github.event.client_payload.orderId }}
        run: |
          python worker.py
