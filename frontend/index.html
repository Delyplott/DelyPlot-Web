<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>Dely Plott Express ‚Äî Ploteos y Doblados</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@500;600;700&display=swap" rel="stylesheet">

  <!-- ‚úÖ RUTAS RELATIVAS (funciona si todo vive en /frontend/ y se publica esa carpeta) -->
  <link rel="stylesheet" href="./styles.css" />

  <!-- Firebase (Compat para usar <script> cl√°sico) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- ‚úÖ Debe cargarse ANTES de script.js -->
  <script src="./firebase-config.js" onerror="window.__FIREBASE_CONFIG_LOAD_FAILED__=true;"></script>
  <script>
    (function () {
      if (window.__FIREBASE_CONFIG_LOAD_FAILED__) {
        alert(
          "No se pudo cargar ./firebase-config.js\n\n" +
          "Aseg√∫rate de que 'firebase-config.js' est√© en la MISMA carpeta que este index.html (frontend/).\n" +
          "Luego haz commit/push y recarga con Ctrl+F5."
        );
        return;
      }
      // Chequeo m√≠nimo (por si carg√≥ pero no defini√≥ variables)
      if (!window.FIREBASE_CONFIG || !window.APPS_SCRIPT_URL) {
        alert(
          "firebase-config.js carg√≥, pero faltan variables.\n\n" +
          "Debe definir:\n" +
          "- window.FIREBASE_CONFIG = {...}\n" +
          "- window.APPS_SCRIPT_URL = 'https://script.google.com/.../exec'\n"
        );
      }
    })();
  </script>

  <!-- (Opcional) Listener temprano postMessage como fallback (NO es cr√≠tico si ya usas polling) -->
  <script>
    (function () {
      window.__DRIVE_UPLOAD_CACHE__ = window.__DRIVE_UPLOAD_CACHE__ || Object.create(null);

      function isFromAppsScript(origin) {
        return origin === "https://script.google.com" ||
               origin === "https://script.googleusercontent.com";
      }

      window.addEventListener("message", function (ev) {
        if (!isFromAppsScript(ev.origin)) return;

        var msg = ev.data || {};
        if (msg.type === "drive_upload_done" && msg.orderId) {
          window.__DRIVE_UPLOAD_CACHE__[String(msg.orderId)] = {
            files: Array.isArray(msg.files) ? msg.files : [],
            ts: Date.now()
          };
        }
      }, false);
    })();
  </script>
</head>

<body>
  <!-- Header + Nav -->
  <header class="site-header">
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo-circle" aria-hidden="true">üñ®Ô∏è</div>
          <div class="brand-text">
            <h1>DELYPLOTT <span>EXPRESS</span></h1>
            <p class="tag">Ploteos y doblados ¬∑ distintos tama√±os/formatos</p>
            <p class="tag small">Planos, pendones, docs e infograf√≠as ¬∑ Atenci√≥n 24/7</p>
          </div>
        </div>

        <nav class="nav" aria-label="Navegaci√≥n principal">
          <a class="link" href="#order-card">Inicio</a>
          <a class="link" href="#como-funciona">C√≥mo funciona</a>
          <a class="link" href="#sobre-nosotros">Sobre nosotros</a>
          <a class="link" href="#contacto">Contacto</a>

          <button class="link theme-toggle" id="theme-toggle" type="button" aria-label="Cambiar tema" title="Cambiar tema">üåô</button>
          <button class="link palette-toggle" id="palette-toggle" type="button" aria-label="Cambiar paleta" title="Cambiar paleta">üé®</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- ===== FORMULARIO ===== -->
    <section id="order-card" class="card">
      <h2>Haz tu pedido</h2>

      <form id="order-form" novalidate>
        <div class="grid">
          <label class="field">
            <span>Nombre y apellido</span>
            <input type="text" name="nombre" placeholder="Tu nombre" required />
          </label>

          <label class="field">
            <span>Tel√©fono</span>
            <input type="tel" name="telefono" placeholder="+56 9 ..." required />
          </label>

          <label class="field">
            <span>Email</span>
            <input type="email" name="email" placeholder="tu@email.com" required />
          </label>

          <label class="field">
            <span>Tama√±o aprox.</span>
            <select name="tamano">
              <option value="A4">A4</option>
              <option value="A3">A3</option>
              <option value="A2">A2</option>
              <option value="A1">A1</option>
              <option value="A0">A0</option>
              <option value="Otro">Otro / lo indico en notas</option>
            </select>
          </label>

          <label class="field">
            <span>Color</span>
            <select name="color">
              <option>Blanco y negro</option>
              <option>Color</option>
            </select>
          </label>

          <label class="field">
            <span>Entrega</span>
            <select name="entrega">
              <option>Retiro en local</option>
              <option>Delivery</option>
            </select>
          </label>
        </div>

        <label class="field">
          <span>Notas</span>
          <textarea name="notas" rows="3" placeholder="Ind√≠canos detalles de ploteo/doblado, direcci√≥n si es delivery, etc."></textarea>
        </label>

        <div class="box" style="margin-top:14px;">
          <p style="margin:0;"><b>Archivos:</b> se cargar√°n en una <b>ventana emergente</b> despu√©s de presionar <b>‚ÄúEnviar pedido‚Äù</b>.</p>
          <p class="tiny" style="margin:8px 0 0;">
            Si no se abre la ventana, habilita <b>pop-ups</b> para este sitio. Formatos: PDF / im√°genes. L√≠mite pr√°ctico Apps Script: ~45&nbsp;MB por archivo.
          </p>
        </div>

        <label class="check">
          <input type="checkbox" id="tyc" required>
          <span>Acepto el procesamiento del archivo para cotizaci√≥n. Ver√© el desglose y el total oficial en pantalla.</span>
        </label>

        <div class="actions">
          <button type="submit" class="btn primary">Enviar pedido</button>
          <span id="form-status" class="status" role="status" aria-live="polite"></span>
        </div>
      </form>
    </section>

    <!-- ===== ESTADO + COTIZACI√ìN OFICIAL ===== -->
    <section id="quote-card" class="card hidden" aria-hidden="true">
      <h2>Estado y cotizaci√≥n</h2>

      <div class="box">
        <p><b>ID Pedido:</b> <span id="order-id">‚Äî</span></p>
        <p><b>Estado:</b> <span id="order-status">‚Äî</span></p>
        <p class="tiny" id="order-hint"></p>
      </div>

      <div class="payment-grid" style="margin-top:14px;">
        <div class="box">
          <h3>Preview</h3>
          <p class="tiny">Cuando est√© listo, podr√°s abrir el PDF de previsualizaci√≥n.</p>
          <p><a id="preview-link" href="#" target="_blank" rel="noopener" class="btn ghost hidden">Abrir preview PDF</a></p>
        </div>

        <div class="box">
          <h3>Cotizaci√≥n oficial (desglose)</h3>
          <div id="quote-container" class="hidden">
            <ul id="quote-breakdown" class="summary"></ul>
            <p style="margin-top:10px;"><b>Total:</b> <span id="quote-total">‚Äî</span></p>
            <p class="tiny" id="quote-formula"></p>
          </div>
          <p id="quote-wait" class="tiny">A√∫n no calculada.</p>
        </div>
      </div>

      <div class="payment-grid" style="margin-top:14px;">
        <div class="box">
          <h3>Datos de transferencia</h3>
          <dl id="bank-data" class="dl"></dl>
          <button id="copy-btn" class="btn ghost" type="button">Copiar datos</button>
        </div>
        <div class="box">
          <h3>Resumen del pedido</h3>
          <ul id="summary" class="summary"></ul>
        </div>
      </div>

      <div class="after-actions">
        <a class="btn primary" href="https://wa.me/56912345678" target="_blank" rel="noopener">Avisar por WhatsApp</a>
        <button id="new-order" class="btn" type="button">Cargar otro pedido</button>
      </div>

      <p class="tiny">El total se calcula en backend (worker) y se escribe como ‚Äúoficial‚Äù en Firestore.</p>
    </section>

    <!-- ===== C√ìMO FUNCIONA ===== -->
    <section id="como-funciona" class="card">
      <h2>C√≥mo funciona</h2>
      <ol class="steps">
        <li><b>Completa el formulario</b> y presiona ‚ÄúEnviar pedido‚Äù.</li>
        <li><b>Se abre una ventana</b> para subir tu archivo a Drive.</li>
        <li><b>Se analiza</b> y recibes preview + desglose oficial de la cotizaci√≥n.</li>
      </ol>
      <p class="tiny">Para archivos muy grandes, ver recomendaciones al final del README.</p>
    </section>

    <section id="sobre-nosotros" class="card">
      <h2>Sobre nosotros</h2>
      <p>
        Somos <b>Delyplott Express</b>, un local <b>fijo y presencial</b> dedicado a ploteos y doblados
        con atenci√≥n r√°pida y flexible.
      </p>
    </section>

    <section id="contacto" class="card">
      <h2>Contacto</h2>
      <div class="contact-grid">
        <div class="box">
          <p><b>WhatsApp:</b> <a href="https://wa.me/56912345678" target="_blank" rel="noopener">+56 9 123 45 678</a></p>
          <p><b>Email:</b> <a href="mailto:pedidos@delyplott.com">pedidos@delyplott.com</a></p>
        </div>
        <div class="box">
          <div class="map">
            <iframe title="Mapa del local"
              src="https://maps.google.com/maps?q=Santiago%20Chile&t=&z=14&ie=UTF8&iwloc=&output=embed"
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"></iframe>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="wrap">
      <p>¬© <span id="year"></span> Delyplott Express ¬∑ <a href="mailto:pedidos@delyplott.com">pedidos@delyplott.com</a></p>
    </div>
  </footer>

  <!-- ‚úÖ script.js al final (y en la misma carpeta que index.html) -->
  <script src="./script.js"></script>
</body>
</html>
